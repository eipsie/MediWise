<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wtu.mapper.DiagnosisRecordMapper">
    
    <!-- 诊断记录关联查询结果映射 -->
    <resultMap id="diagnosisWithNames" type="com.wtu.entity.DiagnosisRecord">
        <id property="id" column="id"/>
        <result property="patientId" column="patient_id"/>
        <result property="doctorId" column="doctor_id"/>
        <result property="symptomsText" column="symptoms_text"/>
        <result property="symptomsStructured" column="symptoms_structured"/>
        <result property="vitalSigns" column="vital_signs"/>
        <result property="llmRequestData" column="llm_request_data"/>
        <result property="llmResponseData" column="llm_response_data"/>
        <result property="finalDiagnosis" column="final_diagnosis"/>
        <result property="treatmentPlan" column="treatment_plan"/>
        <result property="status" column="status"/>
        <result property="diagnosisTime" column="diagnosis_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <!-- 额外的查询结果 -->
        <result property="patientName" column="patient_name"/>
        <result property="doctorName" column="doctor_name"/>
    </resultMap>
    
    <!-- 查询患者诊断记录 -->
    <select id="selectPatientDiagnoses" resultMap="diagnosisWithNames">
        SELECT d.*,
               p.name as patient_name,
               doc.real_name as doctor_name
        FROM diagnosis_record d
        LEFT JOIN patient p ON d.patient_id = p.id
        LEFT JOIN doctor doc ON d.doctor_id = doc.id
        WHERE d.patient_id = #{patientId}
        ORDER BY d.create_time DESC
    </select>
    
    <!-- 根据条件查询诊断记录 -->
    <select id="selectDiagnoses" resultMap="diagnosisWithNames">
        SELECT d.*,
               p.name as patient_name,
               doc.real_name as doctor_name
        FROM diagnosis_record d
        LEFT JOIN patient p ON d.patient_id = p.id
        LEFT JOIN doctor doc ON d.doctor_id = doc.id
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                    p.name LIKE CONCAT('%', #{keyword}, '%')
                    OR d.symptoms_text LIKE CONCAT('%', #{keyword}, '%')
                    OR d.final_diagnosis LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="status != null and status != ''">
                AND d.status = #{status}
            </if>
        </where>
        ORDER BY d.create_time DESC
    </select>
</mapper> 